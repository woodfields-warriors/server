steps:
  
- name: 'gcr.io/cloud-builders/bazel'
  args: ["run", "--define", "REVISION_ID=$REVISION_ID", "push"]

- name: 'supinf/envsubst'
  entrypoint: '/bin/sh'
  args: ['deploy/render.sh']

- name: 'gcr.io/cloud-builders/kubectl'
  args: ['apply', '-f', 'deploy', '--namespace=$BRANCH_NAME']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=prod'

- name: 'gcr.io/cloud-builders/kubectl'
  args:
    - apply
    - --namespace=$BRANCH_NAME
    - -f
    - tmp/ingress.yaml
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=prod'

- name: 'gcr.io/cloud-builders/kubectl'
  args: ['set', 'image', 'deployment', 'server', 'server=gcr.io/ticket-to-ride-216915/server:$REVISION_ID', '--namespace=$BRANCH_NAME']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=prod'
